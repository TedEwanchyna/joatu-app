# -*- mode: ruby -*-
# vi: set ft=ruby :
require "thor"

class JoatuDev < Thor
  desc "setup", "Setup a basic development environment"
  def setup
    unless docker_installed? && boot2docker_installed?
      raise "You need to install docker first. Please follow the instructions here: https://docs.docker.com/installation/"
    end

    docker_init!

    `docker run -d --name='postgres' --cidfile='tmp/postgres.cid' undergroundwebdevelopment/postgres:9.3 2>/dev/null`

    `docker run -d --name='joatu-app' --cidfile='tmp/joatu-app.cid' --link postgres:db joatu/joatu-app:dev 2>/dev/null`
  end

  desc "start", "Starts the dev environment, setting it up if neceesary."
  def start
    setup

    puts "Starting postgres container."
    start_postgres!

    puts "Starting joatu-app container."
    system "docker start `cat tmp/joatu-app.cid` 1>/dev/null"
  end

  desc "stop", "Stops the containers and shuts down boot2docker"
  def stop
    puts "Shutting down postgres container."
    system "docker stop `cat tmp/postgres.cid` 1>/dev/null"
    puts "Shutting down joatu-app container."
    system "docker stop `cat tmp/joatu-app.cid` 1>/dev/null"

    puts "Shutting down boot2docker."
    system "boot2docker halt"
  end

  desc "bash", "Opens a bash shell in the context of the rails app"
  def bash
    setup

    puts "About to start shell. Note, you may have to hit return (enter) to refesh your terminal before you see a prompt."
    start_postgres!

    if File.exist? 'tmp/joatu-shell.cid'
      system "docker start `cat tmp/joatu-shell.cid` 1>/dev/null && docker attach `cat tmp/joatu-shell.cid`"
    else
      system "docker run -ti --name='joatu-app-shell' --cidfile='tmp/joatu-shell.cid' --link postgres:db joatu/joatu-app:dev /bin/bash"
    end
  end

  protected

  def docker_init!
    unless `boot2docker status`.strip == 'running'
      `boot2docker init`
      `boot2docker up`
      host_ip = `boot2docker ip 2>/dev/null`
      `export DOCKER_HOST=tcp://#{host_ip}:2375`
    end
  end

  def docker_installed?
    system 'which docker 2>&1>/dev/null'
  end

  def boot2docker_installed?
    system 'which boot2docker 2>&1>/dev/null'
  end

  def start_postgres!
    system "docker start `cat tmp/postgres.cid` 1>/dev/null"
  end
end
 
JoatuDev.start(ARGV)
